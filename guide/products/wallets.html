<!DOCTYPE html>
<html lang="ru-RU">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Кошельки | ВР Банк</title>
    <meta name="description" content="Документация">
    <meta name="generator" content="VuePress 1.4.0">
    
    
    <link rel="preload" href="/vuepress-deploy/assets/css/0.styles.3e0f91c7.css" as="style"><link rel="preload" href="/vuepress-deploy/assets/js/app.27710d05.js" as="script"><link rel="preload" href="/vuepress-deploy/assets/js/2.6f11ea38.js" as="script"><link rel="preload" href="/vuepress-deploy/assets/js/14.398b1c1d.js" as="script"><link rel="prefetch" href="/vuepress-deploy/assets/js/10.fc83116f.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/11.f6f1558d.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/12.e7a10dab.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/13.9c33cee1.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/15.28d4324d.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/16.47f3b6cc.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/17.00e243c3.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/18.6eb5d586.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/19.d266af46.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/20.d3a51bed.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/3.5f1a156c.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/4.affd53be.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/5.13109f81.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/6.bf6cd42e.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/7.23981709.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/8.37949e91.js"><link rel="prefetch" href="/vuepress-deploy/assets/js/9.076977c1.js">
    <link rel="stylesheet" href="/vuepress-deploy/assets/css/0.styles.3e0f91c7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-deploy/" class="home-link router-link-active"><!----> <span class="site-name">ВР Банк</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-deploy/" class="nav-link">
  Главная
</a></div><div class="nav-item"><a href="/vuepress-deploy/guide/" class="nav-link router-link-active">
  Документация
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Языки" class="dropdown-title"><span class="title">Языки</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-deploy/guide/products/wallets.html" class="nav-link router-link-exact-active router-link-active">
  Русский
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-deploy/en/" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/vuepress-deploy/" class="nav-link">
  Главная
</a></div><div class="nav-item"><a href="/vuepress-deploy/guide/" class="nav-link router-link-active">
  Документация
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Языки" class="dropdown-title"><span class="title">Языки</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-deploy/guide/products/wallets.html" class="nav-link router-link-exact-active router-link-active">
  Русский
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-deploy/en/" class="nav-link">
  en-US
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/vuepress-deploy/guide/" class="sidebar-link">Главная</a></li><li><section class="sidebar-group depth-0"><a href="/vuepress-deploy/guide/products" class="sidebar-heading clickable router-link-active open"><span>Продукты</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-deploy/guide/products/wallets.html" class="active sidebar-link">Кошельки</a></li><li><section class="sidebar-group is-sub-group depth-1"><a href="/vuepress-deploy/guide/products/payin" class="sidebar-heading clickable"><span>Эквайринг</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-deploy/guide/products/payin/cms-bitrix.html" class="sidebar-link">Платёжный модуль для 1С-Битрикс</a></li></ul></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/vuepress-deploy/guide/api" class="sidebar-heading clickable"><span>API</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-deploy/guide/api/payin.html" class="sidebar-link">Эквайринг</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Работа с API</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-deploy/guide/using-api/basic.html" class="sidebar-link">Основы</a></li><li><a href="/vuepress-deploy/guide/using-api/using-sdks.html" class="sidebar-link">Использование SDK</a></li><li><a href="/vuepress-deploy/guide/using-api/testing.html" class="sidebar-link">Тестирование</a></li><li><a href="/vuepress-deploy/guide/using-api/changelog.html" class="sidebar-link">История изменений API</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Платежи</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/vuepress-deploy/guide/payments/quick-start.html" class="sidebar-link">Быстрый старт</a></li><li><a href="/vuepress-deploy/guide/payments/payment-process.html" class="sidebar-link">Процесс платежа</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="кошеnьки"><a href="#кошеnьки" class="header-anchor">#</a> Кошельки</h1> <p></p><div class="table-of-contents"><ul><li><a href="#введение">Введение</a></li><li><a href="#процесс-обработки-данных">Процесс обработки данных</a></li><li><a href="#авторизация-и-защита-информации-при-обмене-html-запросами-откnиками-через-сеть">Авторизация и защита информации при обмене HTML-запросами/откликами через сеть</a></li><li><a href="#параметры-формы-запроса-дnя-торговцев-на-выставnение-счета">Параметры формы запроса для Торговцев на выставление счета</a></li><li><a href="#параметры-откnика-по-созданному-счету">Параметры отклика по созданному счету</a></li><li><a href="#обмен-информацией-посnе-подтверждения-опnаты-счета">Обмен информацией после подтверждения оплаты счета</a></li><li><a href="#параметры-формы-запроса-дnя-торговцев-на-возврат-пnатежа">Параметры формы запроса для Торговцев на возврат платежа</a></li></ul></div><p></p> <h3 id="введение"><a href="#введение" class="header-anchor">#</a> Введение</h3> <p>IPSP предоставляет услугу для списания средств (выполнения платежа) с помощью Модуля электронных кошельков, взаимодействующего с Qiwi, WebMoney, Яндекс.Деньги и определяющего содержание и формат Web-запросов, реализуемых в Internet-браузере Торговцем через Протокол списания средств с электронных кошельков (система Wallets).</p> <h3 id="процесс-обработки-данных"><a href="#процесс-обработки-данных" class="header-anchor">#</a> Процесс обработки данных</h3> <p>Основной процесс обработки данных представлен следующими шагами:</p> <ol><li>Плательщик (Клиент Торговца – владелец кошелька) предлагает Торговцу оплатить продукт (или корзину товаров/услуг) путем списания суммы платежа с его кошелька, открытого в одном из известных сервисов электронных кошельков (Qiwi, WebMoney, Яндекс.Деньги).</li> <li>Internet-магазин Торговца формирует запрос с необходимым набором параметров в JSON-формате, дополняет их данными о продукте и плательщике. Все запросы Торговца подвергаются обработке с помощью ключа JWT, который передается в заголовке запроса (более детальную информацию по обработке с помощью JWT см.ниже в отдельном описании/разделе).</li> <li>Затем по URL он направляет HTTP-POST-запрос в систему Wallets, где при неуспешной валидации возвращается Торговцу один из типовых кодов ошибки, в каждом из которых предусмотрена возможность передачи текстового сообщения с описанием причины отказа от обработки:</li></ol> <ul><li>401 – Unautorized («авторизация не прошла»),</li> <li>403 – Forbidden («транзакция запрещена»),</li> <li>409 – Не удалось создать счет (напр., &quot;Счет с таким merchant_external_id уже существует&quot;), возвращается сообщение и дата</li> <li>422 – &quot;Something is wrong with this field!&quot; (&quot;Ошибка в валидации данных&quot;- выдается, если какие-то переданные данные неверны или не заполнены обязательные поля), возвращается сообщение и одна из причин ошибки</li> <li>500 – «Внутренняя ошибка».</li></ul> <ol start="4"><li>При успешной валидации параметров запроса формируется статус с кодом 201 «Счет создан» (при этом формируется uuid – уникальный идентификатор счета) и в свою очередь из системы Wallet идет HTTP - запрос с этими данными в соответствующий сервис электронных кошельков (Qiwi, WebMoney, Яндекс.Деньги), где еще раз происходит валидация.</li> <li>При неуспешной валидации в сервисе электронных кошельков также формируется одно из типовых сообщений для Торговца:</li></ol> <ul><li>401 – Unautorized («авторизация не прошла»),</li> <li>403 – Forbidden («транзакция запрещена»),</li> <li>404 – «Not Found» («Запрашиваемые параметры не найдены»).</li></ul> <ol start="6"><li>Если же и здесь валидация прошла успешно, то в соответствующем сервисе кошелька формируется ticket формы. После этого система Wallets может отдать торговцу ссылку на оплату счета (при запросе статуса счета параметр pay_url) через предзаполенную форму данного сервиса кошелька.</li> <li>После подтверждения Плательщиком согласия на списание средств (на платежной форме) сервис соответствующего кошелька переводит сумму с кошелька Плательщика на счет VRBank’а, открытый в этом же сервисе кошельков, статус платежа в БД системы Wallet (EWDB– eWallets database) меняется на «Счет оплачен», Торговец делает GET-запрос на получение статуса платежа в системе Wallets, которая после удержания комиссии вместе с данными счета переводит Торговцу остаток списанной суммы. На этом цикл обработки в системе Wallets завершается, а Торговец в свою очередь отпускает
Плательщику оплаченный продукт/услугу.</li></ol> <h3 id="авторизация-и-защита-информации-при-обмене-html-запросами-откnиками-через-сеть"><a href="#авторизация-и-защита-информации-при-обмене-html-запросами-откnиками-через-сеть" class="header-anchor">#</a> Авторизация и защита информации при обмене HTML-запросами/откликами через сеть</h3> <p>При обработке платежей с помощью электронных кошельков используется JWT (JSON Web Token) - открытый стандарт (Request for Comments (RFC) 7519,), который определяет компактный и автономный способ безопасной передачи информации между сторонами в виде объекта JSON. Эта информация может быть проверена и надежна, потому что она имеет цифровую подпись. JWT могут быть подписаны с использованием секретного ключа или пары открытого / секретного ключей. Наиболее распространенные сценарии использования JWT – это авторизация и обмен информацией:</p> <p><strong>Авторизация</strong>
Как только пользователь вошел в систему, каждый последующий запрос будет включать JWT, позволяющий пользователю получать доступ к маршрутам, службам и ресурсам, которые разрешены с этим токеном. Единая регистрация - это функция, которая в настоящее время широко использует JWT из-за ее небольших накладных расходов и способности легко использоваться в разных доменах.</p> <p><strong>Обмен информацией</strong>
JWT являются хорошим способом безопасной передачи информации между сторонами. Поскольку JWT могут быть подписаны - например, с помощью пар открытого / закрытого ключей - вы можете быть уверены, что отправители – это именно те субъекты, кем они себя называют. Кроме того, поскольку подпись рассчитывается с использованием заголовка и полезной нагрузки (см. описание ниже), всегда можно убедиться, что содержимое не было подделано.
В компактной (сериализованной) форме JWT состоит из трех частей, разделенных точками: xxxxx.yyyyy.zzzzz, которые означают [ Header ].[ Payload ].[ Signature ] Заголовок (header) и полезная нагрузка (payload) присутствуют всегда, а вот подпись (signature) может отсутствовать. Заголовок в основном используется для описания криптографических функций, которые применяются для подписи и/или шифрования токена и обычно состоит из двух частей: тип токена (JWT) и используемый алгоритм хеширования подписи – обычно HMAC-SHA256 (HS256), как в данном случае, или RSA. Например, в JSON-формате:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;alg&quot;</span><span class="token operator">:</span> <span class="token string">&quot;HS256&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;typ&quot;</span><span class="token operator">:</span> <span class="token string">&quot;JWT&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>В некоторых случаях подпись, как упомянуто выше, и шифрование могут отсутствовать. Обычно это происходит, когда JWT является частью некоторой уже зашифрованной структуры данных. (в заголовке неподписанного токена заявка alg должна быть равна none). Затем этот JSON кодируется Base64Url для формирования первой части JWT. Вторая часть токена – это полезная нагрузка (payload), в которой размещается вся необходимая пользовательская информация (обычный объект JSON) и которая содержит заявки (требования). Слово &quot;заявка (claims)&quot; в спецификации обозначает просто часть информации и аналогична ключу JSON-объекта. Она представлена в виде пары “имя”: значение, где “имя” всегда является строкой. Заявки – это требования (запросы), касающиеся сущности (обычно информация о пользователе), и дополнительные данные. Здесь ни одно поле не является обязательным. Существует три типа требований: зарегистрированные (служебные), публичные и частные (пользовательские):</p> <p><strong>Зарегистрированные требования</strong>
Это набор предварительно определенных утверждений, которые не являются обязательными, но рекомендуются для предоставления набора полезных, совместимых утверждений. Некоторые из них: iss (эмитент – издатель токена), exp (срок действия), sub (субъект), aud (аудитория – получатели), iat (время создания) и другие3. Полный список заявок приведен в реестре JSON Web Token Claims стандарта RFC 7519.</p> <p><strong>Публичные требования</strong>
Они могут быть определены по желанию теми, кто использует JWT. Но чтобы избежать коллизий, они должны быть определены в реестре веб-токенов IANA JSON или определены как URI (Uniform Resource Identifier), который содержит пространство имен, устойчивое к коллизиям.</p> <p><strong>Частные требования</strong>
Это пользовательские претензии, созданные для обмена информацией между сторонами, которые согласны их использовать и не являются ни зарегистрированными, ни публичными претензиями. Хотя JWT могут быть зашифрованы для обеспечения секретности между сторонами, мы сосредоточимся на подписанных токенах. Подписанные токены могут проверять целостность утверждений, содержащихся в нем, в то время как зашифрованные токены скрывают эти утверждения от других сторон. Когда токены подписаны с использованием пар открытого и закрытого ключей, подпись также удостоверяет, что подписать его может только сторона, имеющая закрытый ключ. При этом применяется алгоритм, который указывается в первом его компоненте заголовка JWT (см.пример выше) с использованием секретного ключа (secret).</p> <p>!!! Более детальное описание можно найти по ссылкам EN - https://jwt.io/, RU - https://proglib.io/p/jsontokens/</p> <p>Для формирования JWT требуется:</p> <ol><li>Указать в поле iat текущее время (current Unix timestamp) .</li> <li>Использовать алгоритм шифрования HS256 .</li> <li>Приложить идентификатор продукта в поле product_id. Параметр product_id дополнительно передается во втором компоненте JWT - поле payload («полезная нагрузка»).</li> <li>Подписать ключом, составленным из последовательности: merchant_id . product_id . merchant_external_id . product_secret_word</li> <li>Полученный токен приложить к http запросу в заголовок 'Authorization: Bearer ' + token</li></ol> <p>!!! Библиотеку под ваш язык программирования можно найти на сайте https://jwt.io.</p> <p>Параметры JWT для создания секретного ключа secret (обязательные):</p> <p>[datatables autoWidth=true paging=false searching=false ordering=false info=false]</p> <table><thead><tr><th style="text-align:left;">Параметр</th> <th style="text-align:center;">Формат</th> <th style="text-align:left;">Описание</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>merchant_id</code></td> <td style="text-align:center;">Integer</td> <td style="text-align:left;">Идентификатор Торговца (внутренний)</td></tr> <tr><td style="text-align:left;"><code>product_id</code></td> <td style="text-align:center;">Integer</td> <td style="text-align:left;">Идентификатор оплачиваемого Продукта / назначения платежа</td></tr> <tr><td style="text-align:left;"><code>merchant_external_id</code></td> <td style="text-align:center;">string maxLength: 191</td> <td style="text-align:left;">Идентификатор счета в системе Торговца</td></tr> <tr><td style="text-align:left;"><code>product_secret_word</code></td> <td style="text-align:center;">Dotted numeric 123.45</td> <td style="text-align:left;">Секретное слово для данного Продукта</td></tr></tbody></table> <p>[/datatables]</p> <h3 id="параметры-формы-запроса-дnя-торговцев-на-выставnение-счета"><a href="#параметры-формы-запроса-дnя-торговцев-на-выставnение-счета" class="header-anchor">#</a> Параметры формы запроса для Торговцев на выставление счета</h3> <p>Для проведения платежа с помощью кошельков необходимо сформировать счет на оплату. URI формы (HTTP URL): https://wallets.ipsp.com/invoices/</p> <p>Параметры HTTP-POST запроса на выставление счета (JSON-format) Торговца:</p> <p>[datatables autoWidth=true paging=false searching=false ordering=false info=false]</p> <table><thead><tr><th style="text-align:left;">Параметр</th> <th style="text-align:center;">Формат</th> <th style="text-align:center;">Обязательность</th> <th style="text-align:left;">Описание</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>merchant_external_id</code></td> <td style="text-align:center;">string maxLength: 191</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">Идентификатор счета в системе Торговца</td></tr> <tr><td style="text-align:left;"><code>wallet</code></td> <td style="text-align:center;">String Enum: Array [3]</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">Тип протокола (Qiwi, WebMoney, Яндекс.Деньги): Enum: &quot;qiwi&quot; &quot;webmoney&quot; &quot;yandex_money&quot;</td></tr> <tr><td style="text-align:left;"><code>amount</code></td> <td style="text-align:center;">number($float) minimum: 0</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">Сумма к оплате в валюте Продукта. Валюта Продукта указывается в настройках Продукта Enum: &quot;RUB&quot; &quot;EUR&quot; &quot;USD&quot; здесь используются рубли)</td></tr> <tr><td style="text-align:left;"><code>сurrency</code></td> <td style="text-align:center;">String</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">Код валюты (пока только рубли): Enum: &quot;RUB&quot; &quot;EUR&quot; &quot;USD&quot;</td></tr> <tr><td style="text-align:left;"><code>expires_at</code></td> <td style="text-align:center;">string($date-time)</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">Дата/время действия выставленного счета, по истечении которой утрачивается возможность его оплаты</td></tr> <tr><td style="text-align:left;"><code>account</code></td> <td style="text-align:center;">string maxLength: 191</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">Идентификатор кошелька (Счет в сервисе кошелька)</td></tr> <tr><td style="text-align:left;"><code>email</code></td> <td style="text-align:center;">String ($email)</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">Электронная почта плательщика (владельца кошелька), которому выставляется счет</td></tr> <tr><td style="text-align:left;"><code>phone</code></td> <td style="text-align:center;">string($E.164) nullable: true</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">Номер телефона плательщика (владельца кошелька), которому выставляется счет на оплату, по стандарту E.164; example: +79671234567</td></tr> <tr><td style="text-align:left;"><code>comments</code></td> <td style="text-align:center;">String</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">Комментарии по счету: не более 255 символов, для yandex_money не более 128 символов</td></tr> <tr><td style="text-align:left;"><code>form</code></td> <td style="text-align:center;">(описаны в отдельных таблицах – см.ниже)</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">WalletForm - форма, состоящая из набора (массива) параметров для одного из видов кошелька: Qiwi (object) or WebMoney (object) or YandexMoney (object)</td></tr></tbody></table> <p>[/datatables]</p> <p>!!!! Оплачиваемый продукт может быть как реальным товаром/услугой, так и собирательным «товаром/услугой», например, корзиной или заказом.</p> <p>Параметры массива <code>form</code> для различных видов кошельков:</p> <p><strong><code>WalletForm = Qiwi</code></strong></p> <p>[datatables autoWidth=true paging=false searching=false ordering=false info=false]</p> <table><thead><tr><th style="text-align:left;">Параметр</th> <th style="text-align:center;">Формат</th> <th style="text-align:center;">Обязательность</th> <th style="text-align:left;">Описание</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>success_url</code></td> <td style="text-align:center;">string($uri)</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">URL для переадресации в случае успешного создания транзакции в Qiwi (должна вести на сайт Торговца)</td></tr> <tr><td style="text-align:left;"><code>fail_url</code></td> <td style="text-align:center;">String($uri)</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">URL для переадресации в случае неуспеха при создании транзакции в QIWI Wallet (должна вести на сайт Торговца)</td></tr> <tr><td style="text-align:left;"><code>iframe</code></td> <td style="text-align:center;">string boolean</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">Признак отображения страницы в iframe (при значении true - более компактный вид, удобный для встраивания ее в сайт провайдера). Если отсутствует, то по умолчанию принимается false</td></tr> <tr><td style="text-align:left;"><code>target</code></td> <td style="text-align:center;">string</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">Value: &quot;iframe&quot; Флаг, показывающий, что ссылки в параметрах successUrl / failUrl открываются в iframe. Если отсутствует, то считается выключенным</td></tr></tbody></table> <p>[/datatables]</p> <p><strong><code>WalletForm = WebMoney</code></strong></p> <p>[datatables autoWidth=true paging=false searching=false ordering=false info=false]</p> <table><thead><tr><th style="text-align:left;">Параметр</th> <th style="text-align:center;">Формат</th> <th style="text-align:center;">Обязательность</th> <th style="text-align:left;">Описание</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>lang</code></td> <td style="text-align:center;">string Enum: &quot;en&quot; &quot;ru&quot;</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">Параметр, определяющий язык формы</td></tr> <tr><td style="text-align:left;"><code>lmi_success_url</code></td> <td style="text-align:center;">String($uri)</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">URL (на веб-сайте Торговца), на который будет переведен интернет-браузер плательщика в случае успешного выполнения платежа</td></tr> <tr><td style="text-align:left;"><code>lmi_success_method</code></td> <td style="text-align:center;">String ($string)</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">Метод (POST, GET или LINK), который будет использоваться при переходе на lmi_success_URL</td></tr> <tr><td style="text-align:left;"><code>lmi_fail_url</code></td> <td style="text-align:center;">String($uri)</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">URL (на веб-сайте Торговца), на который будет переведен интернет-браузер плательщика в случае неуспешного платежа</td></tr> <tr><td style="text-align:left;"><code>lmi_fail_method</code></td> <td style="text-align:center;">String ($string)</td> <td style="text-align:center;">Нет</td> <td style="text-align:left;">Метод (POST, GET или LINK), который будет использоваться при переходе на lmi_fail_url</td></tr></tbody></table> <p>[/datatables]</p> <p><strong><code>WalletForm = Yandex_money</code></strong></p> <p>[datatables autoWidth=true paging=false searching=false ordering=false info=false]</p> <table><thead><tr><th style="text-align:left;">Параметр</th> <th style="text-align:center;">Формат</th> <th style="text-align:center;">Обязательность</th> <th style="text-align:left;">Описание</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>return_url</code></td> <td style="text-align:center;">string($uri)</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">При успешной оплате (и если что-то пойдет не так) Яндекс.Касса вернет пользователя на return_url</td></tr></tbody></table> <p>[/datatables]</p> <p>Ниже дан пример заполнения POST-запроса на создание платежа для кошелька (в данном примере для кошелька Webmoney - перечислены только обязательные параметры, в том числе в массиве form):</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;merchant_external_id&quot;</span><span class="token operator">:</span> 'asdqwe<span class="token number">1313</span>ads<span class="token number">3323</span>'<span class="token punctuation">,</span>
<span class="token property">&quot;wallet&quot;</span><span class="token operator">:</span> 'webmoney'<span class="token punctuation">,</span>
<span class="token property">&quot;amount&quot;</span><span class="token operator">:</span> <span class="token number">100.00</span><span class="token punctuation">,</span>
<span class="token property">&quot;currency&quot;</span><span class="token operator">:</span> 'RUB'<span class="token punctuation">,</span>
<span class="token property">&quot;form&quot;</span><span class="token operator">:</span>
    <span class="token punctuation">{</span>
     <span class="token property">&quot;lmi_success_url&quot;</span><span class="token operator">:</span> 'http<span class="token operator">:</span><span class="token comment">//merch.com/success',</span>
     <span class="token property">&quot;lmi_fail_url&quot;</span><span class="token operator">:</span> 'http<span class="token operator">:</span><span class="token comment">//merch.com/fail',</span>
     <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token property">&quot;expires_at&quot;</span><span class="token operator">:</span> '<span class="token number">2020</span><span class="token number">-01</span><span class="token number">-30</span>T<span class="token number">12</span><span class="token operator">:</span><span class="token number">19</span><span class="token operator">:</span><span class="token number">29.396695</span>Z'<span class="token punctuation">,</span>
<span class="token punctuation">}</span>;
</code></pre></div><p>После того, как счет прошел валидацию сначала в системе Wallets, а затем в сервисе кошелька (Qiwi, WebMoney, Яндекс.Деньги), и получил статус 200 ему присваивается uuid (id предзаполненной формы). По итогам обработки счета Торговцу на URL из его запроса направляется уведомление вместе с uuid и подтверждается его успешный прием. Во все остальных случаях система Wallets будет осуществлять попытки доставить уведомление, увеличивая время между попытками. Если URL в запросе не был передан, будет взят URL из настроек продукта, фигурирующего в созданном счете с идентификатором uuid (например, 3fa85f64-5717-4562-b3fc-2c963f66afa6).</p> <h3 id="параметры-откnика-по-созданному-счету"><a href="#параметры-откnика-по-созданному-счету" class="header-anchor">#</a> Параметры отклика по созданному счету</h3> <p>Для получения информации по созданному счету с данным uuid Торговец направляет HTTP POST-запрос в систему Wallets на указанный URL, например, https://wallets.ipsp.com/invoices/3fa85f64-5717-4562-b3fc-2c963f66afa6 , в ответ на который он получит из системы Wallets HTTP GET-запрос по оплаченному счету с уведомлением Торговцу с полной информацией о созданном счете, содержащем полноценный URL (pay_url) для проведения платежа в сервисе кошелька (Qiwi, WebMoney, Яндекс.Деньги). Если Торговец будет присылать запросы раньше, чем в сервисе кошелька будет создан счет с предзаполненной формой, то он будет получать пустой ответ, пока процесс создания счета там не завершится.</p> <p>Передаваемые параметры отклика (JSON-format) после создания счета следующие:</p> <p>[datatables autoWidth=true paging=false searching=false ordering=false info=false]</p> <table><thead><tr><th style="text-align:left;">Параметр</th> <th style="text-align:center;">Формат</th> <th style="text-align:left;">Описание</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>uuid</code></td> <td style="text-align:center;">String($uuid)</td> <td style="text-align:left;">Invoice UUID - Уникальный идентификатор счета/платежа</td></tr> <tr><td style="text-align:left;"><code>merchant_external_id</code></td> <td style="text-align:center;">string maxLength: 191</td> <td style="text-align:left;"></td></tr> <tr><td style="text-align:left;"><code>wallet</code></td> <td style="text-align:center;">String Enum:Array [3]</td> <td style="text-align:left;">Тип протокола Enum: &quot;qiwi&quot; &quot;webmoney&quot; &quot;yandex_money&quot;</td></tr> <tr><td style="text-align:left;"><code>account</code></td> <td style="text-align:center;">String maxLength: 191</td> <td style="text-align:left;">Идентификатор кошелька Плательщика</td></tr> <tr><td style="text-align:left;"><code>amount</code></td> <td style="text-align:center;">number($float) minimum: 0</td> <td style="text-align:left;">Money - Сумма к списанию</td></tr> <tr><td style="text-align:left;"><code>fee</code></td> <td style="text-align:center;">number($float) minimum: 0</td> <td style="text-align:left;">Money - Сумма взимаемой комиссии</td></tr> <tr><td style="text-align:left;"><code>currency</code></td> <td style="text-align:center;">String Enum:Array [3]</td> <td style="text-align:left;">Код валюты (пока рубли). Enum: &quot;RUB&quot; &quot;EUR&quot; &quot;USD&quot;</td></tr> <tr><td style="text-align:left;"><code>email</code></td> <td style="text-align:center;">string($email) nullable: true</td> <td style="text-align:left;">еМейл плательщика (владельца кошелька)</td></tr> <tr><td style="text-align:left;"><code>phone</code></td> <td style="text-align:center;">String($E.164) nullable: true</td> <td style="text-align:left;">PhoneNumber - Номер телефона клиента (владельца кошелька) в формате E.164 (https://en.wikipedia.org/wiki/E.164)</td></tr> <tr><td style="text-align:left;"><code>comments</code></td> <td style="text-align:center;">String nullable: true</td> <td style="text-align:left;">Комментарии по счету</td></tr> <tr><td style="text-align:left;"><code>paid_at</code></td> <td style="text-align:center;">string($date-time) nullable: true</td> <td style="text-align:left;">Дата прохождения транзакции в сервисах Qiwi, WebMoney, Яндекс.Деньги</td></tr> <tr><td style="text-align:left;"><code>pay_url</code></td> <td style="text-align:center;">string($uri) nullable: true</td> <td style="text-align:left;">URL для получения оповещения о списании суммы платежа</td></tr> <tr><td style="text-align:left;"><code>status</code></td> <td style="text-align:center;">String Enum: Array [6]</td> <td style="text-align:left;">Invoice Status – Статус выставленного счета (Enum: &quot;created&quot; &quot;in_progress&quot; &quot;succeed&quot; &quot;cancelled&quot; &quot;expired&quot; &quot;error&quot;)</td></tr> <tr><td style="text-align:left;"><code>expires_at</code></td> <td style="text-align:center;">string($date-time) nullable: true</td> <td style="text-align:left;">Срок действия счета (возможности оплатить)</td></tr> <tr><td style="text-align:left;"><code>created_at</code></td> <td style="text-align:center;">string($date-time)</td> <td style="text-align:left;">Дата и время создания счета</td></tr> <tr><td style="text-align:left;"><code>updated_at</code></td> <td style="text-align:center;">string($date-time)</td> <td style="text-align:left;">Дата и время обновления статуса счета</td></tr></tbody></table> <p>[/datatables]</p> <p>Пример ответа на GET-запрос (в данном примере для кошелька Webmoney) может выглядеть так:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3fa85f64-5717-4562-b3fc-2c963f66afa6&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;merchant_external_id&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;wallet&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webmoney&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;account&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;amount&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token property">&quot;fee&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token property">&quot;currency&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;email&quot;</span><span class="token operator">:</span> <span class="token string">&quot;user@example.com&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;phone&quot;</span><span class="token operator">:</span> <span class="token string">&quot;+79671234567&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;comments&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;pay_url&quot;</span><span class="token operator">:</span> <span class="token string">&quot;string&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token string">&quot;created&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;expires_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-01-29T14:56:43.735Z&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;created_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-01-29T14:56:43.735Z&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;updated_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-01-29T14:56:43.735Z&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="обмен-информацией-посnе-подтверждения-опnаты-счета"><a href="#обмен-информацией-посnе-подтверждения-опnаты-счета" class="header-anchor">#</a> Обмен информацией после подтверждения оплаты счета</h3> <p>После отправки этого сообщения система Wallets периодически опрашивает сервис соответствующего кошелька (Qiwi, WebMoney, Яндекс.Деньги) об изменении статуса счета на «Счет оплачен». После перехода Плательщика по ссылке pay_url, отправленной ему через Торговца, он попадает в
платежную форму на странице сервиса соответствующего кошелька, где ему предоставляется возможность подтвердить списание требуемой суммы с этого кошелька. После подтверждения Плательщиком списания суммы система Wallets получает информацию от сервиса соответствующего кошелька об изменении статуса счета на «Счет оплачен». Статус счета в БД системы Wallets также изменяется на «Счет оплачен».</p> <h3 id="параметры-формы-запроса-дnя-торговцев-на-возврат-пnатежа"><a href="#параметры-формы-запроса-дnя-торговцев-на-возврат-пnатежа" class="header-anchor">#</a> Параметры формы запроса для Торговцев на возврат платежа</h3> <p>При необходимости возврата Плательщику суммы, списанной с его кошелька, в случае отказа от сделки процесс организован аналогичным образом в виде системы HTTP POST-GET запросов. Для подписи JWT при запросе на возврат платежа параметр merchant_external_id отсутствует. араметр product_id также дополнительно передается в поле payload JWT. Параметры HTTP POST-запроса на возврат следующие:</p> <p>[datatables autoWidth=true paging=false searching=false ordering=false info=false]</p> <table><thead><tr><th style="text-align:left;">Параметр</th> <th style="text-align:center;">Формат</th> <th style="text-align:center;">Обязательность</th> <th style="text-align:left;">Описание</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>invoice</code></td> <td style="text-align:center;">string($uuid)</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">Invoice UUID - Идентификатор счета в системе Торговца</td></tr> <tr><td style="text-align:left;"><code>amount</code></td> <td style="text-align:center;">number($float) minimum: 0</td> <td style="text-align:center;">Да</td> <td style="text-align:left;">Сумма возврата в валюте Продукта (должна быть меньше либо равна сумме счета, по которому производится возврат. Валюта Продукта указывается в настройках Продукта. (здесь используются рубли)</td></tr></tbody></table> <p>[/datatables]</p> <p>Пример POST-запроса:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;invoice&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3fa85f64-5717-4562-b3fc-2c963f66afa6&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;amount&quot;</span><span class="token operator">:</span> <span class="token number">0</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Также как и при выставлении счета возможны следующие исходы (статусы) в уведомлениях при неуспешном возврате:</p> <ul><li>409 – Не удалось создать возврат,</li> <li>422 – &quot;Something is wrong with this field!&quot; (&quot;Ошибка в валидации данных&quot;),</li> <li>500 – «Внутренняя ошибка».</li></ul> <p>При успешном исходе в БД системы Wallets запросу присваивается статус: 201 Результат создания возврата и передается следующий HTTP POST-отклик (Refund):</p> <p>[datatables autoWidth=true paging=false searching=false ordering=false info=false]</p> <table><thead><tr><th style="text-align:left;">Параметр</th> <th style="text-align:center;">Формат</th> <th style="text-align:left;">Описание</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>uuid</code></td> <td style="text-align:center;">String($uuid)</td> <td style="text-align:left;">Refund UUID- Уникальный идентификатор возврата платежа</td></tr> <tr><td style="text-align:left;"><code>wallet</code></td> <td style="text-align:center;">String Enum: Array [3]</td> <td style="text-align:left;">Тип протокола (Qiwi, WebMoney, Яндекс.Деньги) Enum: “qiwi” &quot;webmoney&quot; &quot;yandex_money&quot;</td></tr> <tr><td style="text-align:left;"><code>amount</code></td> <td style="text-align:center;">number($float) minimum: 0</td> <td style="text-align:left;">Money – Возвращаемая сумма</td></tr> <tr><td style="text-align:left;"><code>currency</code></td> <td style="text-align:center;">String</td> <td style="text-align:left;">Код валюты (пока рубли). Enum: &quot;RUB&quot; &quot;EUR&quot; &quot;USD&quot;</td></tr> <tr><td style="text-align:left;"><code>status</code></td> <td style="text-align:center;">String Enum: Array [5]</td> <td style="text-align:left;">Refund Status – Статус возврата Enum: &quot;created&quot; &quot;in_progress&quot; &quot;failed&quot; &quot;succeed&quot; &quot;error&quot;</td></tr> <tr><td style="text-align:left;"><code>created_at</code></td> <td style="text-align:center;">string($date-time)</td> <td style="text-align:left;">Дата и время возврата</td></tr> <tr><td style="text-align:left;"><code>updated_at</code></td> <td style="text-align:center;">string($date-time)</td> <td style="text-align:left;">Дата и время обновления статуса возврата</td></tr></tbody></table> <p>[/datatables]</p> <p>Пример заполнения POST-запроса на возврат:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3fa85f64-5717-4562-b3fc-2c963f66afa6&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;wallet&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webmoney&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;amount&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token property">&quot;currency&quot;</span><span class="token operator">:</span> <span class="token string">&quot;RUB&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token property">&quot;created_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-01-31T18:25:53.976Z&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;updated_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-01-31T18:25:53.976Z&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>При запросе информации о возврате используется uuid так же, как и при создании счета, например, URL https://wallets.ipsp.com/refunds/3fa85f64-5717-4562-b3fc-2c963f66afa6 , и выдается отклик со статусом 404 (Not Found – Не найден) при неуспешном исходе или отклик со статусом 200 (Информация о возврате) при успешном исходе со следующими параметрами.</p> <p>Пример отклика для кошелка Webmoney:</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
<span class="token property">&quot;uuid&quot;</span><span class="token operator">:</span> <span class="token string">&quot;3fa85f64-5717-4562-b3fc-2c963f66afa6&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;wallet&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webmoney&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;amount&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token property">&quot;currency&quot;</span><span class="token operator">:</span> <span class="token string">&quot;RUB&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;status&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
<span class="token property">&quot;created_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-01-31T19:25:03.944Z&quot;</span><span class="token punctuation">,</span>
<span class="token property">&quot;updated_at&quot;</span><span class="token operator">:</span> <span class="token string">&quot;2020-01-31T19:25:03.944Z&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>[datatables autoWidth=true paging=false searching=false ordering=false info=false]</p> <table><thead><tr><th style="text-align:left;">Параметр</th> <th style="text-align:center;">Формат</th> <th style="text-align:left;">Описание</th></tr></thead> <tbody><tr><td style="text-align:left;"><code>uuid</code></td> <td style="text-align:center;">String($uuid)</td> <td style="text-align:left;">Refund UUID- Уникальный идентификатор возврата платежа</td></tr> <tr><td style="text-align:left;"><code>wallet</code></td> <td style="text-align:center;">String Enum: Array [3]</td> <td style="text-align:left;">Тип протокола Enum: &quot;qiwi&quot; &quot;webmoney&quot; &quot;yandex_money&quot;</td></tr> <tr><td style="text-align:left;"><code>amount</code></td> <td style="text-align:center;">number($float) minimum: 0</td> <td style="text-align:left;">Money - Сумма к списанию</td></tr> <tr><td style="text-align:left;"><code>currency</code></td> <td style="text-align:center;">String Enum: Array [3]</td> <td style="text-align:left;">Код валюты (пока рубли). Enum: &quot;RUB&quot; &quot;EUR&quot; &quot;USD&quot;</td></tr> <tr><td style="text-align:left;"><code>status</code></td> <td style="text-align:center;">String Enum: Array [5]</td> <td style="text-align:left;">RefundStatus – Статус возврата Enum: &quot;created&quot; &quot;in_progress&quot; &quot;failed&quot; &quot;succeed&quot; &quot;error&quot;</td></tr> <tr><td style="text-align:left;"><code>created_at</code></td> <td style="text-align:center;">string($date-time)</td> <td style="text-align:left;">Дата и время возврата</td></tr> <tr><td style="text-align:left;"><code>updated_at</code></td> <td style="text-align:center;">string($date-time)</td> <td style="text-align:left;">Дата и время обновления статуса возврата</td></tr></tbody></table> <p>[/datatables]</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/vuepress-deploy/guide/" class="prev router-link-active">
        Главная
      </a></span> <span class="next"><a href="/vuepress-deploy/guide/products/payin/cms-bitrix.html">
        Платёжный модуль для 1С-Битрикс
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/vuepress-deploy/assets/js/app.27710d05.js" defer></script><script src="/vuepress-deploy/assets/js/2.6f11ea38.js" defer></script><script src="/vuepress-deploy/assets/js/14.398b1c1d.js" defer></script>
  </body>
</html>
